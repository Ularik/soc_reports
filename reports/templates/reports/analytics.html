{% extends "base.html" %}
{% block title %}Аналитика по типам атак{% endblock %}

{% block content %}
  <h1>Аналитика по типам атак (в %)</h1>
  <form method="get" class="mb-4">
    <label>С:</label>
    <input type="date" name="start" value="{{ start }}">
    <label>По:</label>
    <input type="date" name="end"   value="{{ end }}">
    <button type="submit" class="btn btn-primary">Показать</button>
  </form>

  {% if labels %}
    <div style="width:30%;">
      <canvas id="attackChart"></canvas>
    </div>
    <!-- Легенда по цветам -->
    <ul id="legend" class="list-unstyled mt-3"></ul>
  {% else %}
    <p>Нет данных за выбранный период.</p>
  {% endif %}
{% endblock %}

{% block scripts %}
  {% if labels %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // Данные из контекста
      const chartLabels = {{ labels|safe }};
      const chartData   = {{ data|safe }};
      // Палитра цветов
      const backgroundColors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
        '#9966FF', '#FF9F40', '#C9CBCF', '#4D5360',
        '#46BFBD', '#FDB45C'
      ].slice(0, chartLabels.length);

      // Инициализация диаграммы
      const ctx = document.getElementById('attackChart').getContext('2d');
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: chartLabels,
          datasets: [{
            data: chartData,
            backgroundColor: backgroundColors,
            label: 'Процент от общего числа атак'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: {
              callbacks: {
                label: ctx => ctx.label + ': ' + ctx.parsed + '%'
              }
            },
            legend: { display: false }
          }
        }
      });

      // Генерация пользовательской легенды
      const legendContainer = document.getElementById('legend');
      chartLabels.forEach((label, i) => {
        const li = document.createElement('li');
        li.innerHTML =
          `<span style="display:inline-block;width:12px;height:12px;background-color:${backgroundColors[i]};margin-right:8px;"></span>` +
          `${label} — ${chartData[i]}%`;
        legendContainer.appendChild(li);
      });
    </script>
  {% endif %}
{% endblock %}
